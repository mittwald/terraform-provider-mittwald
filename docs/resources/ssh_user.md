---
# generated by https://github.com/hashicorp/terraform-plugin-docs
page_title: "mittwald_ssh_user Resource - terraform-provider-mittwald"
subcategory: ""
description: |-
  This resource manages an SSH user for a project.
---

# mittwald_ssh_user (Resource)

This resource manages an SSH user for a project. SSH users can authenticate via password or SSH public keys and provide shell access to the project's file system.

## Example Usage

### Basic Example with Public Key

```terraform
resource "mittwald_ssh_user" "deploy" {
  project_id  = mittwald_project.example.id
  description = "Deployment SSH user"

  public_keys = [
    {
      key     = "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIExample... deploy@example.com"
      comment = "deploy@example.com"
    }
  ]
}
```

### Example with Password Authentication

```terraform
resource "mittwald_ssh_user" "admin" {
  project_id  = mittwald_project.example.id
  description = "Admin SSH user"
  password    = var.ssh_admin_password
}
```

### Example with Expiration Date

```terraform
resource "mittwald_ssh_user" "temporary" {
  project_id  = mittwald_project.example.id
  description = "Temporary access for contractor"
  expires_at  = "2024-12-31T23:59:59Z"

  public_keys = [
    {
      key     = "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQExample..."
      comment = "contractor@company.com"
    }
  ]
}
```

### Integration with Bitbucket Pipelines

This example shows how to set up automated deployments from Bitbucket Pipelines to a mittwald project. It uses the `tls_private_key` resource to generate an SSH key pair and configures Bitbucket deployment variables for use in pipelines.

```terraform
terraform {
  required_providers {
    mittwald = {
      source = "mittwald/mittwald"
    }
    bitbucket = {
      source = "DrFaust92/bitbucket"
    }
    tls = {
      source = "hashicorp/tls"
    }
  }
}

# Bitbucket repository data
data "bitbucket_repository" "main" {
  workspace = "my-workspace"
  repo_slug = "my-app"
}

# Create a deployment environment in Bitbucket
resource "bitbucket_deployment" "production" {
  repository = data.bitbucket_repository.main.full_name
  name       = "Production"
  stage      = "Production"
}

# Generate an SSH key pair for deployment
resource "tls_private_key" "deploy" {
  algorithm = "ED25519"
}

# Create SSH user on mittwald with the generated public key
resource "mittwald_ssh_user" "deploy" {
  project_id  = mittwald_project.main.id
  description = "Bitbucket Pipeline Deployment"

  public_keys = [
    {
      key     = tls_private_key.deploy.public_key_openssh
      comment = "bitbucket-pipeline"
    }
  ]
}

# Configure the SSH key pair in Bitbucket (for pipeline authentication)
resource "bitbucket_pipeline_ssh_key" "deploy" {
  workspace   = data.bitbucket_repository.main.workspace
  repository  = data.bitbucket_repository.main.repo_slug
  public_key  = tls_private_key.deploy.public_key_openssh
  private_key = tls_private_key.deploy.private_key_openssh
}

# Add mittwald SSH server as known host in Bitbucket
# Note: You need to obtain the SSH host key via ssh-keyscan (see below)
variable "mittwald_ssh_host_key" {
  description = "SSH host public key (obtain via: ssh-keyscan -t ed25519 <ssh_host>)"
  type        = string
}

resource "bitbucket_pipeline_ssh_known_host" "mittwald" {
  workspace  = data.bitbucket_repository.main.workspace
  repository = data.bitbucket_repository.main.repo_slug
  hostname   = "[${mittwald_app.api.ssh_host}]:22"

  public_key {
    key_type = "ssh-ed25519"
    key      = var.mittwald_ssh_host_key
  }
}

# Pass SSH connection details to Bitbucket as deployment variables
resource "bitbucket_deployment_variable" "ssh_host" {
  deployment = bitbucket_deployment.production.id
  key        = "SSH_HOST"
  value      = mittwald_app.api.ssh_host
  secured    = false
}

resource "bitbucket_deployment_variable" "ssh_user" {
  deployment = bitbucket_deployment.production.id
  key        = "SSH_USER"
  value      = "${mittwald_ssh_user.deploy.username}@${mittwald_app.api.short_id}"
  secured    = false
}

resource "bitbucket_deployment_variable" "deploy_path" {
  deployment = bitbucket_deployment.production.id
  key        = "DEPLOY_PATH"
  value      = mittwald_app.api.installation_path_absolute
  secured    = false
}
```

#### Obtaining the SSH Host Key

To configure `bitbucket_pipeline_ssh_known_host`, you need the SSH host key of the mittwald server. After your app is created, obtain it using `ssh-keyscan`:

```bash
# Use the ssh_host from your mittwald_app resource
ssh-keyscan -t ed25519 ssh.xxx.mittwald.net
```

This will output something like:
```
ssh.xxx.mittwald.net ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAA...
```

Extract the key (everything after `ssh-ed25519 `) for use in your `mittwald_ssh_host_key` variable.

#### Example bitbucket-pipelines.yml

```yaml
pipelines:
  branches:
    main:
      - step:
          name: Deploy to mittwald
          deployment: Production
          script:
            - rsync -avz --delete -e "ssh -p 22" ./dist/ ${SSH_USER}@${SSH_HOST}:${DEPLOY_PATH}/
```

The deployment variables `SSH_HOST`, `SSH_USER`, and `DEPLOY_PATH` are automatically available in the pipeline when using the `deployment: Production` reference.

#### Security Considerations

When using `tls_private_key`:

1. **State Security**: The private key will be stored in your Terraform state. Ensure your state backend is encrypted (e.g., S3 with encryption, Terraform Cloud, etc.).

2. **Key Rotation**: Consider implementing key rotation by using `terraform taint tls_private_key.deploy` periodically.

3. **Alternative**: If you prefer not to store private keys in Terraform state, generate the key pair externally and pass them as sensitive variables:

```terraform
variable "deploy_private_key" {
  type      = string
  sensitive = true
}

variable "deploy_public_key" {
  type = string
}

resource "mittwald_ssh_user" "deploy" {
  project_id  = mittwald_project.example.id
  description = "Deployment SSH user"

  public_keys = [
    {
      key     = var.deploy_public_key
      comment = "deployment-key"
    }
  ]
}
```

<!-- schema generated by tfplugindocs -->
## Schema

### Required

- `description` (String) A description for the SSH user
- `project_id` (String) The ID of the project the SSH user belongs to

### Optional

- `active` (Boolean) Whether the SSH user is active. Defaults to `true`.
- `expires_at` (String) The expiration date of the SSH user in RFC3339 format (e.g., `2024-12-31T23:59:59Z`). If not set, the user does not expire.
- `password` (String, Sensitive) Password for SSH authentication. Either `password` or `public_keys` must be provided. Maximum 72 characters. This is a write-only attribute and will not be read back from the API.
- `public_keys` (Attributes List) List of SSH public keys for authentication. Either `public_keys` or `password` must be provided. (see [below for nested schema](#nestedatt--public_keys))

### Read-Only

- `created_at` (String) The creation timestamp of the SSH user in RFC3339 format
- `id` (String) The generated SSH user ID
- `username` (String) The generated username for SSH authentication. This is automatically generated by the API and cannot be changed.

<a id="nestedatt--public_keys"></a>
### Nested Schema for `public_keys`

Required:

- `comment` (String) A comment/label for the key (e.g., email address or identifier)
- `key` (String) The SSH public key (e.g., `ssh-rsa AAAA... user@host`)

## Import

Import is supported using the SSH user ID:

```shell
terraform import mittwald_ssh_user.example <ssh-user-id>
```
